{% load static %}
<link rel="stylesheet" type="text/css" href="{% static 'game/action_log.css' %}">

<div id="actions_container" class="panel panel-default">
    <div class="pic-header panel-heading">
            <h4 class="panel-title">Игра<span class="pull-right">Ссылка на игру: <input id="hashlink" type="text"><span class="glyphicon glyphicon-refresh" id="rehash_game"></span></span></h4>
        <script>function rel_to_abs(url){
    /* Only accept commonly trusted protocols:
     * Only data-image URLs are accepted, Exotic flavours (escaped slash,
     * html-entitied characters) are not supported to keep the function fast */
  if(/^(https?|file|ftps?|mailto|javascript|data:image\/[^;]{2,9};):/i.test(url))
         return url; //Url is already absolute

    var base_url = location.href.match(/^(.+)\/?(?:#.+)?$/)[0]+"/";
    if(url.substring(0,2) == "//")
        return location.protocol + url;
    else if(url.charAt(0) == "/")
        return location.protocol + "//" + location.host + url;
    else if(url.substring(0,2) == "./")
        url = "." + url;
    else if(/^\s*$/.test(url))
        return ""; //Empty = Return nothing
    else url = "../" + url;

    url = base_url + url;
    var i=0
    while(/\/\.\.\//.test(url = url.replace(/[^\/]+\/+\.\.\//g,"")));

    /* Escape certain characters to prevent XSS */
    url = url.replace(/\.$/,"").replace(/\/\./g,"").replace(/"/g,"%22")
            .replace(/'/g,"%27").replace(/</g,"%3C").replace(/>/g,"%3E");
    return url;
}

$('#hashlink').val(rel_to_abs("{% url 'join_game' gamehash=parms.game %}"));
$('#rehash_game').on("click", function(){
     $.ajax({
           type: "GET",
           url: "{% url 'rehash' parms.game %}",
           success: function(data)
           {
              $('#hashlink').val(rel_to_abs(data.newhash));
           }
         });
});
</script>
    </div>
    <div id="actions" class="msg-wrap">
        {% for action in parms.actions %}
            <div  class="clearfix msg">
                <div class="col-md-12" id="action{{action.action.pk}}">
                    {% include 'game/action.html' with action=action.action char=action.char phrase=action.action_phrase flavour=action.char_flavour rolls=action.rolls form=action.form %}
                </div>
            </div>
        {% endfor %}
    </div>
    <script>
    $('#actions').scrollTop($('#actions')[0].scrollHeight);
        setInterval(function() {
                       $.ajax({
                           type: "GET",
                           url: "{% url 'get_actions'  %}",
                           success: function(data)
                           {
                               $.each(data.new, function(key,val) {
                                    $.get("{% url 'get_action' %}?action="+val, function(data){
                                        $('#actions').append('<div  class="clearfix msg"><div class="col-md-12" id="action'+val+'">'+data+'</div></div>');
                                    });
                                    $('#actions').scrollTop($('#actions')[0].scrollHeight);
                               });
                               $.each(data.updated, function(key,val) {
                                    $('#action'+val).load("{% url 'get_action' %}?action="+val)
                               });
                           }
                         });
                    }
                , 15000);
    </script>
</div>